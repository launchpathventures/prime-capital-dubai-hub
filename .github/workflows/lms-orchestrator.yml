name: LMS Issue Orchestrator

on:
  pull_request:
    types: [closed]
    branches: [master]
  workflow_dispatch:
    inputs:
      check_all:
        description: 'Check all issue dependencies'
        required: false
        default: 'true'

jobs:
  orchestrate:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Check dependencies and notify
        uses: actions/github-script@v7
        with:
          script: |
            // LMS Issue dependency map
            const dependencies = {
              124: [100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111], // LMS-002
              125: [124], // LMS-003
              126: [125], // LMS-004
              127: [126], // LMS-005
              128: [127], // LMS-006
              129: [128], // LMS-007
              130: [129], // LMS-008
              131: [130], // LMS-009
              132: [131], // LMS-010
              133: [128], // LMS-011 (parallel after 006)
            };
            
            // Get all closed issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const closedIssues = new Set(
              issues.filter(i => i.state === 'closed').map(i => i.number)
            );
            
            // Check each dependent issue
            for (const [issueNum, deps] of Object.entries(dependencies)) {
              const issue = issues.find(i => i.number === parseInt(issueNum));
              if (!issue || issue.state === 'closed') continue;
              
              const allDepsMet = deps.every(dep => closedIssues.has(dep));
              
              if (allDepsMet) {
                // Check if we already commented
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum)
                });
                
                const alreadyNotified = comments.some(c => 
                  c.body.includes('âœ… All dependencies complete')
                );
                
                if (!alreadyNotified) {
                  const issueUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNum}`;
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNum),
                    body: `## âœ… All dependencies complete!

This issue is now ready to be worked on.

**Completed dependencies:**
${deps.map(d => `- #${d}`).join('\n')}

---

### ðŸ‘‰ [Click here to assign Copilot](${issueUrl})

1. Click the link above
2. In the right sidebar, click "Assignees"
3. Select "Copilot"

*Note: Copilot assignment cannot be automated via API yet.*`
                  });
                  
                  // Also add a label so you can filter these easily
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNum),
                    labels: ['ready-for-copilot']
                  });
                  
                  console.log(`Notified issue #${issueNum} - ready to start`);
                }
              }
            }
